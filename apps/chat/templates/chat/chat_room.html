{% extends 'base.html' %}
{% block title %}Chat {% endblock %}

{% block content %}
    <div class="row">
        <div class="col-md-6 offset-md-3">
            <h2 class="text-center" id="room_name">{{room_name}}</h2>

            <h4>Members:</h4>
            <ul id="members-list">
                {% for membership in members %}
                    <li>{{ membership.user.full_name }}</li>
                {% endfor %}
            </ul>


            <div id="chat-box" class="border p-3 mb-3" style="height: 300px; overflow-y: scroll;">
                {% for message in chat_messages %}
                    <div class="message">
                        <strong>{{ message.user }}</strong> 
                        <span class="text-muted">{{ message.created_at }}</span>
                        <p>{{ message.content }}</p>
                    </div>
                {% endfor %}
            </div>
            <div class="form-group">
                <input type="text" id="message-input" class="form-control" placeholder="Type a message...">
            </div>
            <button id="send-button" class="btn btn-primary btn-block">Send</button>
        </div>
    </div>
{% endblock %}

{% block beforebodyend %}
<script>
    $(document).ready(function() {
        const roomName = $("#room_name").text();
        const chatBox = $("#chat-box");
        const messageInput = $("#message-input");
        const sendButton = $("#send-button");

        const socket = new WebSocket("ws://" + window.location.host + "/ws/chat/" + roomName + "/");

        socket.onopen = function() {
            console.log("WebSocket connection established.");
        };

        socket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            const message = data.message;
            const user = data.user;
            const timestamp = data.timestamp;

            const messageHtml = `
                <div class="message">
                    <strong>${user}</strong> <span class="text-muted">[${timestamp}]</span>
                    <p>${message}</p>
                </div>
            `;
            chatBox.append(messageHtml);
            chatBox.scrollTop(chatBox[0].scrollHeight);
        };

        sendButton.click(function() {
            const message = messageInput.val();
            if (message.trim()) {
                socket.send(JSON.stringify({ "message": message }));
                messageInput.val(''); 
            }
        });

        messageInput.keypress(function(e) {
            if (e.which === 13) {
                sendButton.click();
            }
        });

        socket.onclose = function(e) {
            console.log("WebSocket closed. Reason: " + e.reason);
        };
    });
</script>

{% endblock %}
